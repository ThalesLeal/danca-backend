{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}

<h2 class="pb-2">{{ titulo }}</h2>

<!--- Mensagens de erro -->
{% if form.errors %}
<div class="container">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      {% for error in form.non_field_errors %}
        <div class="alert alert-error alert-dismissible fade show" role="alert">
          {{ error }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
      {% for field in form %}
        {% for error in field.errors %}
        <div class="alert alert-error alert-dismissible fade show" role="alert">
          {{ error }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<form method="post" id="artistaForm">
  {% csrf_token %}

  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="me-3" for="{{ form.nome.id_for_label }}">{{ form.nome.label }}</label>
      {{ form.nome }}
    </div>
    
    <div class="col-md-6 mb-3">
      <label class="me-3" for="{{ form.funcao.id_for_label }}">{{ form.funcao.label }}</label>
      {{ form.funcao }}
    </div>
    
    <div class="col-md-6 mb-3">
      <label class="me-3" for="{{ form.cache.id_for_label }}">{{ form.cache.label }}</label>
      {{ form.cache }}
    </div>
    
    <div class="col-md-6 mb-3">
      <label class="me-3">Eventos</label>
      <div class="input-group mb-3">
        <input type="text" class="form-control" id="evento-search" placeholder="Pesquisar eventos...">
        <button class="btn btn-outline-secondary" type="button" id="add-evento">Adicionar</button>
      </div>
      <div class="mt-2" id="eventos-list">
        <div class="alert alert-info" role="alert">
          Selecione os eventos abaixo:
        </div>
        <div class="list-group" id="eventos-available">
          {% for evento in form.eventos.field.queryset %}
            <button type="button" class="list-group-item list-group-item-action evento-item" data-evento-id="{{ evento.id }}">
              {{ evento.descricao }}{% if evento.quantidade_pessoas is not None %} ({{ evento.quantidade_pessoas }} vagas){% endif %}
            </button>
          {% endfor %}
        </div>
        <div class="mt-3">
          <h6>Eventos Selecionados:</h6>
          <div class="list-group" id="eventos-selected">
            {% for evento_id in form.eventos.value|default_if_none:""|safe %}
              {% if evento_id %}
                {% with evento=evento_id|get_evento %}
                  {% if evento %}
                    <div class="list-group-item d-flex justify-content-between align-items-center selected">
                      {{ evento.descricao }}{% if evento.quantidade_pessoas is not None %} ({{ evento.quantidade_pessoas }} vagas){% endif %}
                      <button type="button" class="btn btn-sm btn-danger remove-evento" data-evento-id="{{ evento.id }}">
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </div>
                  {% endif %}
                {% endwith %}
              {% endif %}
            {% endfor %}
          </div>
        </div>
        <input type="hidden" name="eventos" id="eventos-hidden" value="{{ form.eventos.value|default_if_none:""|safe }}">
      </div>
    </div>
  </div>

  <button type="submit" class="btn btn-success me-2 float-end"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-floppy" viewBox="0 0 16 16">
    <path d="M11 2H9v3h2z"/>
    <path d="M1.5 0h11.586a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13A1.5 1.5 0 0 1 1.5 0M1 1.5v13a.5.5 0 0 0 .5.5H2v-4.5A1.5 1.5 0 0 1 3.5 9h9a1.5 1.5 0 0 1 1.5 1.5V15h.5a.5.5 0 0 0 .5-.5V2.914a.5.5 0 0 0-.146-.353l-1.415-1.415A.5.5 0 0 0 13.086 1H13v4.5A1.5 1.5 0 0 1 11.5 7h-7A1.5 1.5 0 0 1 3 5.5V1H1.5a.5.5 0 0 0-.5.5m3 4a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V1H4zM3 15h10v-4.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5z"/>
  </svg> &nbsp; Salvar</button>
  <a href="{% url 'list_artistas' %}" class="btn btn-secondary"><i class="bi bi-arrow-90deg-left"></i> Voltar</a>
</form>

<!-- Adicionando o JavaScript -->
<script src="{% static 'js/jquery.min.js' %}"></script>
<script src="{% static 'js/jquery.mask.min.js' %}"></script>
<script src="{% static 'js/mascaras.js' %}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("#artistaForm");
    if (form) {
      form.addEventListener("submit", function () {
        const valorInput = document.querySelector(".mask-valor");
        if (valorInput) {
          valorInput.value = valorInput.value.replace("R$", "").replace(/\./g, "").replace(",", ".").trim();
        }
      });
    }

    // Evento de busca
    const searchInput = document.querySelector("#evento-search");
    const eventosAvailable = document.querySelector("#eventos-available");
    
    searchInput.addEventListener("input", function() {
      const searchTerm = this.value.toLowerCase();
      const eventoItems = eventosAvailable.querySelectorAll(".evento-item");
      
      eventoItems.forEach(item => {
        const eventoText = item.textContent.toLowerCase();
        if (eventoText.includes(searchTerm)) {
          item.style.display = "";
        } else {
          item.style.display = "none";
        }
      });
    });

    // Adicionar evento
    const addEventoButton = document.querySelector("#add-evento");
    const eventosSelected = document.querySelector("#eventos-selected");
    const eventosHidden = document.querySelector("#eventos-hidden");

    addEventoButton.addEventListener("click", function() {
      const selectedEvento = eventosAvailable.querySelector(".evento-item:not([style*='display: none'])");
      if (selectedEvento) {
        const eventoId = selectedEvento.dataset.eventoId;
        const eventoText = selectedEvento.textContent;
        
        // Verificar se j√° existe
        if (!document.querySelector(`[data-evento-id='${eventoId}'].selected`)) {
          const selectedDiv = document.createElement("div");
          selectedDiv.className = "list-group-item d-flex justify-content-between align-items-center selected";
          selectedDiv.innerHTML = `
            ${eventoText}
            <button type="button" class="btn btn-sm btn-danger remove-evento" data-evento-id="${eventoId}">
              <i class="bi bi-x-lg"></i>
            </button>
          `;
          eventosSelected.appendChild(selectedDiv);
          
          // Atualizar valor oculto
          const selectedIds = Array.from(document.querySelectorAll(".selected"))
            .map(item => item.querySelector("button").dataset.eventoId);
          eventosHidden.value = selectedIds.join(",");
        }
      }
    });

    // Remover evento
    eventosSelected.addEventListener("click", function(e) {
      if (e.target.classList.contains("remove-evento")) {
        const selectedDiv = e.target.closest(".selected");
        selectedDiv.remove();
        
        // Atualizar valor oculto
        const selectedIds = Array.from(document.querySelectorAll(".selected"))
          .map(item => item.querySelector("button").dataset.eventoId);
        eventosHidden.value = selectedIds.join(",");
      }
    });
  });
</script>

{% endblock %}