{% extends 'base.html' %}
{% load static %}

{% block content %}

<h2 class="pb-2">{{ titulo }}</h2>

<!--- Mensagens de erro -->
{% if form.errors %}
<div class="container">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      {% for error in form.non_field_errors %}
        <div class="alert alert-error alert-dismissible fade show" role="alert">
          {{ error }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
      {% for field in form %}
        {% for error in field.errors %}
        <div class="alert alert-error alert-dismissible fade show" role="alert">
          {{ error }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<form method="post" id="pedidoForm">
  {% csrf_token %}

  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="me-3" for="cliente_tipo">Tipo de Cliente</label>
      <select class="form-select" id="cliente_tipo" name="tipo_cliente" required>
        <option value="">Selecione...</option>
        <option value="inscricao" {% if form.tipo_cliente.value == 'inscricao' %}selected{% endif %}>Congressista</option>
        <option value="profissional" {% if form.tipo_cliente.value == 'profissional' %}selected{% endif %}>Profissional</option>
      </select>
    </div>
    
    <div class="col-md-6 mb-3">
      <label class="me-3" for="cliente_id">Cliente</label>
      <select class="form-select" id="cliente_id" name="cliente_id" required {% if not form.tipo_cliente.value %}disabled{% endif %}>
        <option value="">{% if form.tipo_cliente.value %}Selecione...{% else %}Selecione o tipo de cliente primeiro{% endif %}</option>
        {% if cliente_selecionado %}
          <option value="{{ cliente_selecionado.id }}" selected>{{ cliente_selecionado.nome }}</option>
        {% endif %}
      </select>
    </div>
    
    <div class="col-md-6 mb-3">
      <label class="me-3" for="{{ form.camisa.id_for_label }}">{{ form.camisa.label }}</label>
      {{ form.camisa }}
    </div>
    
    <div class="col-md-3 mb-3">
      <label class="me-3" for="{{ form.tamanho.id_for_label }}">{{ form.tamanho.label }}</label>
      {{ form.tamanho }}
    </div>
    
    <div class="col-md-3 mb-3">
      <label class="me-3" for="{{ form.cor.id_for_label }}">{{ form.cor.label }}</label>
      {{ form.cor }}
    </div>
    
    <div class="col-md-6 mb-3">
      <label class="me-3" for="{{ form.valor_venda.id_for_label }}">{{ form.valor_venda.label }}</label>
      {{ form.valor_venda }}
    </div>
    
    <div class="col-md-6 mb-3">
      <label class="me-3" for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
      {{ form.status }}
    </div>
  </div>

  <button type="submit" class="btn btn-success me-2 float-end">
    <i class="bi bi-floppy"></i> &nbsp; Salvar
  </button>
  <a href="{% url 'list_pedidos_camisas' %}" class="btn btn-secondary"><i class="bi bi-arrow-90deg-left"></i> Voltar</a>
</form>

<script>
  document.addEventListener("DOMContentLoaded", function() {
      const clienteTipo = document.getElementById("cliente_tipo");
      const clienteSelect = document.getElementById("cliente_id");
      
      function carregarClientes(tipo) {
          if (!tipo) {
              clienteSelect.innerHTML = '<option value="">Selecione o tipo primeiro</option>';
              clienteSelect.disabled = true;
              return;
          }
  
          fetch(`/api/clientes/?tipo=${tipo}`)
              .then(response => {
                  if (!response.ok) {
                      throw new Error(`Erro ${response.status}: ${response.statusText}`);
                  }
                  return response.json();
              })
              .then(data => {
                  let options = '<option value="">Selecione...</option>';
                  data.forEach(cliente => {
                      options += `<option value="${cliente.id}">${cliente.nome}</option>`;
                  });
                  clienteSelect.innerHTML = options;
                  clienteSelect.disabled = false;
                  
                  // Restaura seleção se existir
                  {% if cliente_selecionado %}
                      if (document.querySelector(`#cliente_id option[value="{{ cliente_selecionado.id }}"]`)) {
                          clienteSelect.value = "{{ cliente_selecionado.id }}";
                      }
                  {% endif %}
              })
              .catch(error => {
                  console.error('Erro ao carregar clientes:', error);
                  clienteSelect.innerHTML = `
                      <option value="">
                          Erro ao carregar clientes. Recarregue a página.
                      </option>
                  `;
              });
      }
      
      clienteTipo.addEventListener("change", function() {
          carregarClientes(this.value);
      });
      
      // Inicializa se já tiver valor
      if (clienteTipo.value) {
          carregarClientes(clienteTipo.value);
      }
      
      // Validação do formulário
      document.getElementById("pedidoForm").addEventListener("submit", function(e) {
          if (!clienteTipo.value || !clienteSelect.value || clienteSelect.value === "") {
              e.preventDefault();
              alert("Por favor, selecione o tipo e o cliente");
          }
      });
  });
</script>

{% endblock %}