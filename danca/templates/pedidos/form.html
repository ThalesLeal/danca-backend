{% extends 'base.html' %}
{% load static %}

{% block content %}

<h2 class="pb-2">{{ titulo }}</h2>

<!--- Mensagens de erro -->
{% if form.errors %}
<div class="container">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      {% for error in form.non_field_errors %}
        <div class="alert alert-error alert-dismissible fade show" role="alert">
          {{ error }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
      {% for field in form %}
        {% for error in field.errors %}
        <div class="alert alert-error alert-dismissible fade show" role="alert">
          {{ error }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<form method="post" id="pedidoCamisaForm">
  {% csrf_token %}

  <div class="row">
    <div class="col-md-6 mb-3">
      <label class="me-3" for="{{ form.nome_completo.id_for_label }}">{{ form.nome_completo.label }}</label>
      {{ form.nome_completo }}
    </div>
    
    <div class="col-md-6 mb-3">
      <label class="me-3" for="{{ form.cidade.id_for_label }}">{{ form.cidade.label }}</label>
      {{ form.cidade }}
    </div>   
    
    <div class="col-md-12 mb-3">
      <label class="me-3">{{ form.tipo_cliente.label }}</label>
      <div class="form-check form-check-inline">
        {% for choice in form.tipo_cliente %}
          {{ choice.tag }}
          <label class="form-check-label me-3" for="{{ choice.id_for_label }}">
            {{ choice.choice_label }}
          </label>
        {% endfor %}
      </div>
    </div>
    
    <div class="col-md-4 mb-3">
      <label class="me-3" for="{{ form.camisa.id_for_label }}">{{ form.camisa.label }}</label>
      {{ form.camisa }}
    </div>
    
    <div class="col-md-4 mb-3">
      <label class="me-3" for="{{ form.tamanho.id_for_label }}">{{ form.tamanho.label }}</label>
      {{ form.tamanho }}
    </div>
    
    <div class="col-md-4 mb-3">
      <label class="me-3" for="{{ form.cor.id_for_label }}">{{ form.cor.label }}</label>
      {{ form.cor }}
    </div>
    
    <div class="col-md-6 mb-3">
      <label class="me-3" for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
      {{ form.status }}
    </div>
    
    {% if form.instance.valor_venda %}
    <div class="col-md-6 mb-3">
      <label class="me-3">Valor do Pedido:</label>
      <div class="form-control-plaintext">R$ {{ form.instance.valor_venda|floatformat:2 }}</div>
    </div>
    {% endif %}
  </div>

  <button type="submit" class="btn btn-success me-2 float-end">
    <i class="bi bi-floppy"></i> &nbsp; Salvar
  </button>
  <a href="{% url 'list_pedidos' %}" class="btn btn-secondary"><i class="bi bi-arrow-90deg-left"></i> Voltar</a>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Atualizar valor quando a camisa ou tipo de cliente mudar
    const camisaSelect = document.querySelector("#id_camisa");
    const tipoClienteRadios = document.querySelectorAll("input[name='tipo_cliente']");
    
    function updateValorVenda() {
        const camisaId = camisaSelect.value;
        const tipoCliente = document.querySelector("input[name='tipo_cliente']:checked").value;
        
        if (camisaId) {
            fetch(`/api/camisas/${camisaId}/valor/?tipo_cliente=${tipoCliente}`)
                .then(response => response.json())
                .then(data => {
                    const valorElement = document.querySelector("#valor-venda");
                    if (valorElement) {
                        valorElement.textContent = `R$ ${data.valor.toFixed(2)}`;
                    }
                });
        }
    }
    
    if (camisaSelect && tipoClienteRadios.length > 0) {
        camisaSelect.addEventListener("change", updateValorVenda);
        tipoClienteRadios.forEach(radio => {
            radio.addEventListener("change", updateValorVenda);
        });
    }
});
</script>

{% endblock %}